{# app/templates/available_tasks.html (AFFICHAGE EN CARTES) #}
{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4 mb-5"> {# Conteneur principal #}
    <h1><i class="bi bi-list-task"></i> {{ title }}</h1>
    <p>{{ _('Voici les tâches qui correspondent à votre profil (Pays: %(country)s, Appareil: %(device)s) et que vous n\'avez pas encore accomplies.', country=current_user.country, device=current_user.device) }}</p>
    <hr class="mb-4">

    {% if not tasks %}
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle-fill"></i> {{ _('Aucune nouvelle tâche disponible pour le moment.') }}
        </div>
    {% else %}
        {# Grille responsive pour les cartes #}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for task in tasks %}
            <div class="col d-flex align-items-stretch">
                <div class="card h-100 shadow-sm border-0"> {# Cartes sans bordure #}
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">{{ task.title }}</h5>
                            <span class="badge bg-success rounded-pill ms-2">$ {{ "%.2f"|format(task.reward_amount) }}</span>
                        </div>
                        <p class="card-text text-muted flex-grow-1"><small>{{ task.description }}</small></p>

                        {# Zone des boutons en bas #}
                        <div class="mt-auto border-top pt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                {# Bouton Commencer #}
                                {% if task.task_link %}
                                <a href="{{ task.task_link }}" target="_blank" class="btn btn-primary btn-sm"><i class="bi bi-box-arrow-up-right"></i> {{ _('Commencer') }}</a>
                                {% else %}
                                <button class="btn btn-secondary btn-sm" disabled><i class="bi bi-box-arrow-up-right"></i> {{ _('Commencer') }}</button>
                                {% endif %}

                                {# Bouton Marquer Terminé #}
                                <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#confirmCompleteModal{{ task.id }}">
                                    <i class="bi bi-check2-circle"></i> {{ _('Terminé') }}
                                </button>

                                {# Bouton Partager #}
                                <a href="{{ url_for('main.view_external_task', task_id=task.id, ref=current_user.referral_code, _external=True) }}" class="btn btn-secondary btn-sm" target="_blank" title="{{ _('Partager cette tâche') }}">
                                    <i class="bi bi-share-fill"></i> {{ _('Partager') }}
                                </a>
                            </div>
                            <small class="text-danger fst-italic d-block text-center mt-2" title="{{ config.FRAUD_WARNING }}"><i class="bi bi-exclamation-triangle"></i> {{ _('Évitez la fraude') }}</small>
                        </div>
                    </div> {# Fin card-body #}
                </div> {# Fin card #}

                {# Fenêtre Modale de Confirmation #}
                <div class="modal fade" id="confirmCompleteModal{{ task.id }}" tabindex="-1" aria-labelledby="confirmCompleteModalLabel{{ task.id }}" aria-hidden="true">
                  <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header bg-warning text-dark"> <h5 class="modal-title" id="confirmCompleteModalLabel{{ task.id }}"><i class="bi bi-exclamation-triangle-fill"></i> {{ _('Confirmation Requise') }}</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <p><strong>{{ _('ATTENTION !') }}</strong></p> <p>{{ _("Vous êtes sur le point de marquer la tâche '%(title)s' comme terminée.", title=task.title) }}</p> <p class="text-danger fw-bold">{{ _("Ne confirmez que si vous avez réellement et entièrement accompli cette tâche selon les instructions.") }}</p> <p class="text-danger">{{ _("Toute tentative de marquer une tâche comme terminée sans l'avoir réellement faite est considérée comme une fraude, entraînera un bannissement immédiat de la plateforme et l'annulation de tous vos gains accumulés.") }}</p> <p>{{ _("Êtes-vous sûr de vouloir continuer ?") }}</p> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Annuler') }}</button> <form action="{{ url_for('main.complete_task', task_id=task.id) }}" method="post" style="display: inline;"> <button type="submit" class="btn btn-success">{{ _('Confirmer l\'Accomplissement') }}</button> </form> </div> </div> </div>
                </div>{# --- Fin Modale --- #}

            </div> {# Fin col #}
            {% endfor %} {# Fin boucle tâches #}
        </div> {# Fin row (grille de cartes) #}
    {% endif %} {# Fin if not tasks #}

    {# Lien retour #}
    <div class="mt-5 text-center">
         {% if current_user.is_admin %} <a href="{{ url_for('admin.index') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left-circle"></i> {{ _('Retour au Panel Admin') }}</a>
         {% else %} <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left-circle"></i> {{ _('Retour au Tableau de Bord') }}</a> {% endif %}
    </div>
</div> {# Fin container #}
{% endblock %}

{% block scripts %} {{ super() }} {% endblock %}