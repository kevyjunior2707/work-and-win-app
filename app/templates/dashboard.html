{# app/templates/dashboard.html (Avec Résumé Parrainage) #}
{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="row">
        <div class="col-md-12">
            <h1 class="mb-3"><i class="bi bi-speedometer2"></i> {{ title }}</h1>
            <p class="lead">{{ _('Bienvenue sur votre tableau de bord, %(username)s !', username=current_user.full_name) }}</p>

            {% if not current_user.is_verified %}
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">{{ _('Vérification d\'email requise !') }}</h4>
                <p>{{ _('Votre adresse email n\'a pas encore été vérifiée. Veuillez consulter votre boîte de réception (et votre dossier spam) pour l\'email de vérification que nous vous avons envoyé. Si vous ne l\'avez pas reçu, vous pouvez demander un nouveau lien.') }}</p>
                <hr>
                <form action="{{ url_for('auth.resend_verification_email') }}" method="post" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-warning btn-sm">{{ _('Renvoyer l\'email de vérification') }}</button>
                </form>
            </div>
            {% endif %}

            {% if warning_message %}
            <div class="alert alert-danger d-flex align-items-center mt-3" role="alert">
              <i class="bi bi-shield-exclamation fs-2 me-3"></i>
              <div>
                <h4 class="alert-heading">{{ _("Tolérance Zéro pour la Fraude !") }}</h4>
                {{ warning_message }}
              </div>
            </div>
            {% endif %}
            <hr class="my-4">
        </div>
    </div>

    <div class="row g-4">
        {# Carte Solde Actuel #}
        <div class="col-md-6 col-lg-4">
            <div class="card text-center shadow-sm h-100">
                <div class="card-header">
                    <h5 class="my-1"><i class="bi bi-wallet2"></i> {{ _('Mon Solde Actuel') }}</h5>
                </div>
                <div class="card-body">
                    <h1 class="display-4 fw-bold text-success">$ {{ "%.2f"|format(current_user.balance) }}</h1>
                    <p class="card-text">{{ _('C\'est le montant que vous pouvez actuellement retirer.') }}</p>
                </div>
                <div class="card-footer">
                     <a href="{{ url_for('main.withdraw') }}" class="btn btn-primary"><i class="bi bi-cash-coin"></i> {{ _('Demander un Retrait') }}</a>
                </div>
            </div>
        </div>

        {# Carte Tâches Disponibles #}
        <div class="col-md-6 col-lg-4">
            <div class="card text-center shadow-sm h-100">
                <div class="card-header">
                    <h5 class="my-1"><i class="bi bi-card-checklist"></i> {{ _('Tâches') }}</h5>
                </div>
                <div class="card-body">
                    <p class="card-text fs-5">{{ _('Découvrez de nouvelles opportunités de gagner de l\'argent.') }}</p>
                    <p>{{ _('Nombre de tâches accomplies :')}} <strong>{{ current_user.completed_task_count }}</strong></p>
                </div>
                <div class="card-footer">
                    <a href="{{ url_for('main.available_tasks') }}" class="btn btn-success"><i class="bi bi-search"></i> {{ _('Voir les Tâches Disponibles') }}</a>
                    <a href="{{ url_for('main.completed_tasks') }}" class="btn btn-outline-secondary mt-2 mt-md-0 ms-md-2"><i class="bi bi-check2-square"></i> {{ _('Mes Tâches Accomplies') }}</a>
                </div>
            </div>
        </div>

        {# <<< NOUVELLE CARTE : RÉSUMÉ DU PARRAINAGE >>> #}
        <div class="col-md-6 col-lg-4">
            <div class="card text-center shadow-sm h-100">
                <div class="card-header">
                    <h5 class="my-1"><i class="bi bi-people-fill"></i> {{ _('Mon Programme de Parrainage') }}</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        {{ _('Nombre de filleuls :') }} <strong class="fs-5">{{ referred_users_count }}</strong>
                    </p>
                    <p class="card-text">
                        {{ _('Gains de parrainage (approuvés) :') }} <strong class="fs-5 text-success">$ {{ "%.2f"|format(total_referral_earnings) }}</strong>
                    </p>
                     <p class="mt-2">
                        <small>{{ _('Votre code de parrainage :') }}</small>
                        <strong class="user-select-all ms-1">{{ current_user.referral_code }}</strong>
                    </p>
                    {% set reg_link = url_for('auth.register', ref=current_user.referral_code, _external=True) %}
                    <button class="btn btn-sm btn-outline-info mt-1" type="button" onclick="copyToClipboard('{{ reg_link }}')" title="{{ _('Copier le lien d\'invitation') }}">
                        <i class="bi bi-clipboard"></i> {{ _('Copier Lien d\'Invitation') }}
                    </button>
                </div>
                <div class="card-footer">
                    <a href="{{ url_for('main.my_referrals_details') }}" class="btn btn-info text-white"><i class="bi bi-eye-fill"></i> {{ _('Voir Détails de mes Filleuls') }}</a>
                </div>
            </div>
        </div>
        {# <<< FIN NOUVELLE CARTE : RÉSUMÉ DU PARRAINAGE >>> #}

        {# Carte Profil #}
        <div class="col-md-6 col-lg-4">
            <div class="card text-center shadow-sm h-100">
                 <div class="card-header">
                    <h5 class="my-1"><i class="bi bi-person-circle"></i> {{ _('Mon Profil') }}</h5>
                </div>
                <div class="card-body">
                    <p class="card-text fs-5">{{ _('Gardez vos informations personnelles à jour.')}}</p>
                </div>
                <div class="card-footer">
                     <a href="{{ url_for('main.profile') }}" class="btn btn-secondary"><i class="bi bi-pencil"></i> {{ _('Modifier Mon Profil') }}</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                var originalButtonText = event.target.innerHTML;
                event.target.innerHTML = '<i class="bi bi-check-lg"></i> {{ _("Copié !") }}';
                setTimeout(function() {
                    event.target.innerHTML = originalButtonText;
                }, 2000);
            }, function(err) {
                alert("{{ _('Erreur lors de la copie du lien : ') }}" + err);
            });
        }
    </script>
{% endblock %}
