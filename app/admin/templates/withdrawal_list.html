{# app/admin/templates/withdrawal_list.html (COMPLET avec Container/Filtre/Pagination) #}
{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4 mb-5"> {# <<< Conteneur principal pour l'espacement >>> #}
    <h1><i class="bi bi-credit-card"></i> {{ title }}</h1>
    <p>{{ _('Cette page liste les utilisateurs et vous permet d\'enregistrer les paiements de retrait que vous effectuez manuellement.') }}</p>
    <p class="text-danger fw-bold">{{ _("L'enregistrement d'un paiement ici mettra à jour le solde de l'utilisateur et sa date de dernier retrait.") }}</p>

    {# --- Formulaire de Filtre --- #}
    <div class="card bg-light mb-3 shadow-sm filter-card"> {# Carte pour encadrer les filtres #}
        <div class="card-body">
            <form method="GET" action="{{ url_for('admin.list_withdrawals') }}">
                <div class="row g-3 align-items-end">
                    <div class="col-md-5">
                        <label for="name" class="form-label">{{ _('Filtrer par Nom') }}</label>
                        {# Pré-remplit avec la recherche précédente #}
                        <input type="text" class="form-control form-control-sm" id="name" name="name" value="{{ search_name or '' }}">
                    </div>
                     <div class="col-md-5">
                        <label for="email" class="form-label">{{ _('Filtrer par Email') }}</label>
                        <input type="text" class="form-control form-control-sm" id="email" name="email" value="{{ search_email or '' }}">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-sm w-100"><i class="bi bi-search"></i> {{ _('Filtrer') }}</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {# --- Fin Formulaire de Filtre --- #}
    <hr>

    {% if not users %}
        {# Message si aucun utilisateur (ou aucun résultat de filtre) #}
        <div class="alert alert-info">
             {% if search_name or search_email %}
                {{ _('Aucun utilisateur ne correspond à vos critères de recherche.') }}
                 <a href="{{ url_for('admin.list_withdrawals') }}" class="alert-link">{{ _('Voir tous les utilisateurs.') }}</a>
             {% else %}
                {{ _('Aucun utilisateur (non-admin) trouvé.') }}
             {% endif %}
        </div>
    {% else %}
        {# Affichage du tableau des utilisateurs #}
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm align-middle"> {# Classes pour style/alignement #}
                <thead>
                    <tr>
                        <th># ID</th>
                        <th>{{ _('Nom') }}</th>
                        <th>{{ _('Email') }}</th>
                        <th>{{ _('Solde Actuel') }}</th>
                        <th>{{ _('Dernier Retrait (UTC)') }}</th>
                        <th>{{ _('Enregistrer un Paiement Manuel') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {# Boucle sur les utilisateurs de la page actuelle (via pagination) #}
                    {% for user in users %}
                    <tr>
                        <th scope="row">{{ user.id }}</th>
                        <td>{{ user.full_name }}</td>
                        <td>{{ user.email }}</td>
                        {# Affiche le solde formaté à 2 décimales #}
                        <td><strong>$ {{ "%.2f"|format(user.balance) }}</strong></td>
                        {# Affiche la date du dernier retrait ou 'Jamais' #}
                        <td>{{ user.last_withdrawal_date.strftime('%Y-%m-%d %H:%M') if user.last_withdrawal_date else _('Jamais') }}</td>
                        <td>
                            {# Formulaire pour enregistrer le paiement pour CET utilisateur #}
                            <form action="{{ url_for('admin.record_withdrawal', user_id=user.id) }}" method="POST" class="row gx-2 align-items-center">
                                <div class="col-auto">
                                    <label for="amount_{{ user.id }}" class="visually-hidden">{{ _('Montant Payé') }}</label>
                                    <div class="input-group input-group-sm"> {# Groupe pour $ et champ #}
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control form-control-sm" id="amount_{{ user.id }}" name="amount" step="0.01" min="0.01" placeholder="{{ _('Montant') }}" required style="width: 100px;">
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-success btn-sm">{{ _('Enregistrer Paiement') }}</button>
                                </div>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# --- Pagination --- #}
        {# S'affiche seulement s'il y a plus d'une page #}
        {% if pagination and pagination.pages > 1 %}
        <nav aria-label="Page navigation retraits" class="mt-3">
          <ul class="pagination justify-content-center">
             {# Liens Previous/Next en passant les arguments de recherche pour qu'ils persistent #}
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('admin.list_withdrawals', page=pagination.prev_num, name=search_name, email=search_email) if pagination.has_prev else '#' }}">{{ _('Précédent') }}</a>
            </li>
            {# Affiche le numéro de page actuel et total #}
            <li class="page-item active" aria-current="page">
              <span class="page-link">{{ pagination.page }} / {{ pagination.pages }}</span>
            </li>
            {# Pour une pagination plus complète avec les numéros de page:
               {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                 {% if page_num %}
                   {% if pagination.page == page_num %}
                     <li class="page-item active" aria-current="page"><span class="page-link">{{ page_num }}</span></li>
                   {% else %}
                     <li class="page-item"><a class="page-link" href="{{ url_for('admin.list_withdrawals', page=page_num, name=search_name, email=search_email) }}">{{ page_num }}</a></li>
                   {% endif %}
                 {% else %}
                   <li class="page-item disabled"><span class="page-link">...</span></li>
                 {% endif %}
               {% endfor %}
            #}
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('admin.list_withdrawals', page=pagination.next_num, name=search_name, email=search_email) if pagination.has_next else '#' }}">{{ _('Suivant') }}</a>
            </li>
          </ul>
        </nav>
        {% endif %}
        {# --- Fin Pagination --- #}

    {% endif %} {# Fin du else (s'il y a des utilisateurs) #}

    {# Bouton Retour #}
    <div class="mt-4">
        <a href="{{ url_for('admin.index') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left-circle"></i> {{ _('Retour au Panel Admin') }}</a>
    </div>
</div> {# <<< Fin Conteneur >>> #}
{% endblock %}

